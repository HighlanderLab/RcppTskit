# Notes on R package development

## Next TODOs

* Hide pointer functions and organise docs!?

 Missing link(s) in Rd file 'TreeSequence.Rd':
     ‘ts_dump’ ‘ts_summary’

   Missing link(s) in Rd file 'ts_print.Rd':
     ‘ts_summary’

   Missing link(s) in Rd file 'ts_py_to_r.Rd':
     ‘ts_dump’

   Missing link(s) in Rd file 'ts_r_to_py.Rd':
     ‘ts_dump’

   See section 'Cross-references' in the 'Writing R Extensions' manual.

   Found the following Rd file(s) with Rd \link{} targets missing package
   anchors:
     TreeSequence.Rd: ts_dump, ts_summary
     ts_print.Rd: ts_summary
     ts_py_to_r.Rd: ts_dump
     ts_r_to_py.Rd: ts_dump
   Please provide package anchors for all Rd \link{} targets not in the
   package itself and the base packages.


* TODO building tree sequence
extern/tskit/c/tests/testlib.c has lots of examples of constructing a tree sequence using C
extern/tskit/c/tests/test_minimal_cpp.cpp has some C++ example too
extern/tskit/c/examples/haploid_wright_fisher.c
extern/tskit/c/examples/multichrom_wright_fisher_singlethreaded.c
extern/tskit/c/examples/multichrom_wright_fisher.c

This test nicely shows the required columns:

static void
test_missing_required_columns(void)
{
    int ret;
    size_t j;
    tsk_treeseq_t *ts = caterpillar_tree(5, 3, 3);
    tsk_table_collection_t t;
    const char *required_cols[] = {
        "edges/child",
        "edges/left",
        "edges/parent",
        "edges/right",
        "format/name",
        "format/version",
        "individuals/flags",
        "migrations/dest",
        "migrations/left",
        "migrations/node",
        "migrations/right",
        "migrations/source",
        "migrations/time",
        "mutations/node",
        "mutations/parent",
        "mutations/site",
        "nodes/flags",
        "nodes/individual",
        "nodes/population",
        "nodes/time",
        "sequence_length",
        "sites/position",
        "uuid",
    };
    const char *drop_cols[1];

    for (j = 0; j < sizeof(required_cols) / sizeof(*required_cols); j++) {
        drop_cols[0] = required_cols[j];
        copy_store_drop_columns(ts, 1, drop_cols, _tmp_file_name);
        ret = tsk_table_collection_load(&t, _tmp_file_name, 0);
        CU_ASSERT_EQUAL_FATAL(ret, TSK_ERR_REQUIRED_COL_NOT_FOUND);
        tsk_table_collection_free(&t);
    }

    tsk_treeseq_free(ts);
    free(ts);
}

## Setup

```
install.packages(c("usethis", "devtools"))
```

## Code testing coverage with covr

```
install.packages("covr")

# https://usethis.r-lib.org/reference/use_coverage.html
usethis::use_coverage(type = "codecov")

# Build the report
cov <- covr::package_coverage(clean = TRUE)

# Interactive HTML report with uncovered lines highlighted
covr::report(cov)

# List lines with zero coverage per file
covr::zero_coverage(cov)

# Show coverage for a specific file
covr::report(cov, file = "R/RcppTskit-package.R")
covr::report(cov, file = "src/RcppTskit_minimal.cpp")

# If you want a quick text view of uncovered lines:
covr::file_coverage("R/RcppTskit-package.R", "tests/testthat")
covr::file_coverage("src/RcppTskit_minimal.cpp", "tests/testthat")
```

To ignore specific lines, use `# nocov`

To ignore multiple lines use `# nocov start/stop`.

In `Rcpp` code use `// # nocov ...`.

## Air formatter of R code

https://usethis.r-lib.org/reference/use_air.html
```
usethis::use_air()
```

Setup editor and `air.toml`.

In comand line, run:

```
air format .
air format --check .
```

## Jarl linter of R code

https://jarl.etiennebacher.com

Setup editor and `jarl.toml`. Can also do `~/.config/jarl`.

```
jarl check .
jarl check --fix .
```

## clang-format of C/C++ code

```
# All files (run from the RcppTskit directory)
find src -type f \( -name '*.c' -o -name '*.cpp' -o -name '*.h' -o -name '*.hpp' \) \
  ! -path 'inst/include/tskit/*' \
  ! -path 'src/tskit/*' \
  ! -path 'src/RcppExports.cpp' \
  -exec clang-format -i {} +

# All files (run from the repo root)
find . -type f \( -name '*.c' -o -name '*.cpp' -o -name '*.h' -o -name '*.hpp' \) \
  ! -path './extern/*' \
  ! -path './RcppTskit/inst/include/tskit/*' \
  ! -path './RcppTskit/src/tskit/*' \
  ! -path './RcppTskit/src/RcppExports.cpp' \
  -exec clang-format -i {} +

# Single file
clang-format -i --style=file src/RcppTskit_minimal.cpp

# Only changes
git diff --name-only main | grep -E '\.(c|cpp|h|hpp)$' | xargs clang-format -i
```

or

```
pre-commit run clang-format src/RcppTskit.cpp
pre-commit run clang-format --all-files
```

## clang-tidy linter of C/C++ code

```
echo $(brew --prefix llvm)/bin/clang-tidy
# /opt/homebrew/opt/llvm/bin/clang-tidy
export CLANG_TIDY="$(brew --prefix llvm)/bin/clang-tidy"
./tools/clang-tidy.py src/RcppTskit.cpp
./RcppTskit/tools/clang-tidy.py RcppTskit/src/test_tsk_abort_stderr.cpp -- -system-headers '-header-filter=.*'   -extra-arg=-Wno-unknown-warning-option
./tools/clang-tidy.py src/test_tsk_abort_stderr.cpp -- -system-headers '-header-filter=.*'   -extra-arg=-Wno-unknown-warning-option
```

or

```
pre-commit run clang-tidy src/RcppTskit.cpp
pre-commit run clang-tidy --all-files
```

## GitHub actions

```
install.packages("usethis")

# R CMD check
usethis::use_github_action("check-standard")

# Code testing coverage with covr
usethis::use_github_action("test-coverage")

# Air formatting --> moved to pre-commit
usethis::use_github_action(url = "https://github.com/posit-dev/setup-air/blob/main/examples/format-suggest.yaml")
usethis::use_github_action(url = "https://github.com/posit-dev/setup-air/blob/main/examples/format-check.yaml")
```
